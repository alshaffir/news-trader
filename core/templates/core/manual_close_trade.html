{% extends 'core/base.html' %}

{% block title %}Open Trades - News Trader{% endblock %}

{% block extra_head %}
<!-- Bootstrap 5 CSS -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<!-- Font Awesome for icons -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
<style>
    body {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    .main-container {
        padding-top: 20px;
        max-width: 1400px;
        margin: 0 auto;
    }

    .header-section {
        background: rgba(255, 255, 255, 0.95);
        border-radius: 15px;
        padding: 30px;
        margin-bottom: 30px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        backdrop-filter: blur(10px);
    }

    .card {
        background: rgba(255, 255, 255, 0.95);
        border: none;
        border-radius: 15px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        margin-bottom: 20px;
        overflow: hidden;
    }

    .profit-positive {
        color: #28a745;
        font-weight: bold;
    }

    .profit-negative {
        color: #dc3545;
        font-weight: bold;
    }

    .profit-neutral {
        color: #6c757d;
    }

    .direction-long {
        color: #28a745;
        font-weight: bold;
    }

    .direction-short {
        color: #dc3545;
        font-weight: bold;
    }

    .status-badge {
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 0.85em;
        font-weight: 500;
    }

    .status-open {
        background-color: #d4edda;
        color: #155724;
    }

    .close-btn {
        background: linear-gradient(45deg, #dc3545, #c82333);
        border: none;
        color: white;
        border-radius: 8px;
        padding: 8px 16px;
        transition: all 0.3s ease;
        font-size: 0.875rem;
        display: inline-flex;
        align-items: center;
        gap: 6px;
    }

    .close-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(220, 53, 69, 0.3);
        color: white;
    }

    .edit-btn {
        background: linear-gradient(45deg, #007bff, #0056b3);
        border: none;
        color: white;
        border-radius: 8px;
        padding: 8px 16px;
        transition: all 0.3s ease;
        font-size: 0.875rem;
        display: inline-flex;
        align-items: center;
        gap: 6px;
    }

    .edit-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 123, 255, 0.3);
        color: white;
    }

    .close-all-btn {
        background: linear-gradient(45deg, #dc3545, #c82333);
        border: none;
        color: white;
        border-radius: 8px;
        padding: 10px 20px;
        transition: all 0.3s ease;
        font-size: 0.9rem;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        margin-bottom: 20px;
    }

    .close-all-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(220, 53, 69, 0.4);
        color: white;
    }

    .actions-column {
        min-width: 140px;
    }

    .action-buttons {
        display: flex;
        gap: 8px;
        justify-content: center;
        flex-wrap: wrap;
    }

    .table {
        margin-bottom: 0;
    }

    .table thead th {
        background: linear-gradient(45deg, #667eea, #764ba2);
        color: white;
        border: none;
        font-weight: 600;
        text-transform: uppercase;
        font-size: 0.9em;
        letter-spacing: 0.5px;
    }

    .table td {
        vertical-align: middle;
        border-color: #e9ecef;
        padding: 15px 12px;
    }

    .tp-sl-badge {
        display: inline-block;
        background: #e3f2fd;
        color: #1976d2;
        padding: 2px 6px;
        border-radius: 4px;
        font-size: 0.7em;
        margin-left: 5px;
    }

    .duration {
        font-size: 0.9em;
        color: #6c757d;
    }

    .metric-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 20px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    }

    .symbol-badge {
        background: linear-gradient(45deg, #4facfe 0%, #00f2fe 100%);
        color: white;
        padding: 4px 8px;
        border-radius: 6px;
        font-weight: bold;
        font-size: 0.9rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid main-container">
    <!-- Header Section -->
    <div class="header-section">
        <div class="row align-items-center">
            <div class="col-md-6">
                <h1 class="mb-3">
                    <i class="fas fa-chart-line me-3"></i>Open Trades Management
                </h1>
                <p class="mb-0 text-muted">Monitor and manage your active trading positions</p>
            </div>
            <div class="col-md-6">
                <div class="row">
                    <div class="col-md-6">
                        <div class="card text-center">
                            <div class="card-body">
                                <h5 class="card-title">{{ open_trades|length }}</h5>
                                <p class="card-text text-muted">Open Positions</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card text-center">
                            <div class="card-body">
                                <h5 class="card-title {% if total_unrealized_pnl > 0 %}profit-positive{% elif total_unrealized_pnl < 0 %}profit-negative{% else %}profit-neutral{% endif %}">{% if total_unrealized_pnl > 0 %}+${{ total_unrealized_pnl|floatformat:2 }}{% elif total_unrealized_pnl < 0 %}${{ total_unrealized_pnl|floatformat:2 }}{% else %}$0.00{% endif %}</h5>
                                        <p class="card-text text-muted">Total P&L</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Close All Button -->
    {% if open_trades %}
    <div class="text-center">
        <button type="button" class="close-all-btn" data-bs-toggle="modal" data-bs-target="#closeAllModal">
            <i class="fas fa-times-circle"></i>
            Close All Positions ({{ open_trades|length }})
        </button>
    </div>
    {% endif %}

    <!-- Open Trades Table -->
    <div class="card">
        <div class="card-header" style="background: linear-gradient(45deg, #667eea, #764ba2); color: white;">
            <h5 class="mb-0">
                <i class="fas fa-coins me-2"></i>Active Positions
                <span class="badge bg-light text-dark ms-2">{{ open_trades|length }}</span>
            </h5>
        </div>
        <div class="card-body p-0">
            {% if open_trades %}
            <div class="table-responsive">
                <table class="table table-hover mb-0">
                    <thead>
                        <tr>
                            <th><i class="fas fa-tag me-1"></i>Symbol</th>
                            <th><i class="fas fa-exchange-alt me-1"></i>Direction</th>
                            <th><i class="fas fa-coins me-1"></i>Quantity</th>
                            <th><i class="fas fa-dollar-sign me-1"></i>Entry Price</th>
                            <th><i class="fas fa-info-circle me-1"></i>Status</th>
                            <th><i class="fas fa-chart-area me-1"></i>P&L</th>
                            <th class="actions-column"><i class="fas fa-cogs me-1"></i>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for trade in open_trades %}
                        <tr>
                            <td>
                                <span class="symbol-badge">{{ trade.symbol }}</span>
                                {% if trade.take_profit_price %}
                                <span class="tp-sl-badge"
                                    title="Take Profit: ${{ trade.take_profit_price|floatformat:2 }}">TP</span>
                                {% endif %}
                                {% if trade.stop_loss_price %}
                                <span class="tp-sl-badge"
                                    title="Stop Loss: ${{ trade.stop_loss_price|floatformat:2 }}">SL</span>
                                {% endif %}
                            </td>
                            <td>
                                <span
                                    class="{% if trade.direction == 'buy' %}direction-long{% else %}direction-short{% endif %}">
                                    {% if trade.direction == 'buy' %}
                                    <i class="fas fa-arrow-up me-1"></i>LONG
                                    {% else %}
                                    <i class="fas fa-arrow-down me-1"></i>SHORT
                                    {% endif %}
                                </span>
                            </td>
                            <td><strong>{{ trade.quantity|floatformat:0 }}</strong></td>
                            <td><strong>${{ trade.entry_price|floatformat:2 }}</strong></td>
                            <td>
                                <span class="status-badge status-open">{{ trade.status|capfirst }}</span>
                            </td>
                            <td>
                                {% if trade.alpaca_position %}
                                {% if trade.unrealized_pnl > 0 %}
                                <span class="profit-positive">
                                    <i class="fas fa-arrow-up me-1"></i>+${{ trade.unrealized_pnl|floatformat:2 }}
                                </span>
                                {% elif trade.unrealized_pnl < 0 %} <span class="profit-negative">
                                    <i class="fas fa-arrow-down me-1"></i>${{ trade.unrealized_pnl|floatformat:2 }}
                                    </span>
                                    {% else %}
                                    <span class="profit-neutral">
                                        <i class="fas fa-minus me-1"></i>$0.00
                                    </span>
                                    {% endif %}
                                    {% else %}
                                    <span class="profit-neutral">
                                        <i class="fas fa-minus me-1"></i>$0.00
                                    </span>
                                    {% endif %}
                            </td>
                            <td>
                                <div class="action-buttons">
                                    <button type="button" class="edit-btn" data-bs-toggle="modal"
                                        data-bs-target="#editTradeModal" data-trade-id="{{ trade.id }}"
                                        data-symbol="{{ trade.symbol }}" data-entry-price="{{ trade.entry_price }}"
                                        data-current-pnl="{{ trade.unrealized_pnl|default:0 }}"
                                        data-quantity="{{ trade.quantity }}">
                                        <i class="fas fa-pencil-alt"></i>Edit
                                    </button>
                                    <button type="button" class="close-btn" data-bs-toggle="modal"
                                        data-bs-target="#closeTradeModal" data-trade-id="{{ trade.id }}"
                                        data-symbol="{{ trade.symbol }}" data-quantity="{{ trade.quantity }}"
                                        data-pnl="{{ trade.unrealized_pnl|default:0 }}">
                                        <i class="fas fa-times"></i>Close
                                    </button>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="text-center py-5">
                <i class="fas fa-chart-line fa-3x text-muted mb-3"></i>
                <h5 class="text-muted">No Open Trades</h5>
                <p class="text-muted">All positions have been closed or no trades have been executed yet.</p>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Close Trade Confirmation Modal -->
<div class="modal fade" id="closeTradeModal" tabindex="-1" aria-labelledby="closeTradeModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="closeTradeModalLabel">
                    <i class="fas fa-exclamation-triangle text-warning me-2"></i>Confirm Trade Closure
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i>
                    <strong>You are about to close this position:</strong>
                </div>
                <div class="row">
                    <div class="col-md-6">
                        <p><strong>Symbol:</strong> <span id="close-symbol">-</span></p>
                        <p><strong>Quantity:</strong> <span id="close-quantity">-</span> shares</p>
                    </div>
                    <div class="col-md-6">
                        <p><strong>Current P&L:</strong> <span id="close-pnl" class="fw-bold">-</span></p>
                        <p><strong>Status:</strong> <span class="badge bg-warning">Will be closed</span></p>
                    </div>
                </div>
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <strong>This action cannot be undone.</strong> The position will be closed at the current market
                    price.
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-1"></i>Cancel
                </button>
                <form method="post" style="display: inline;" id="closeTradeForm">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="close_trade">
                    <input type="hidden" name="trade_id" value="" id="close-trade-id">
                    <button type="submit" class="btn btn-danger">
                        <i class="fas fa-times me-1"></i>Close Position
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Edit Trade Modal -->
<div class="modal fade" id="editTradeModal" tabindex="-1" aria-labelledby="editTradeModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editTradeModalLabel">
                    <i class="fas fa-pencil-alt me-2"></i>Edit Trade Settings
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form method="post" id="editTradeForm">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="edit_trade">
                    <input type="hidden" name="trade_id" id="edit-trade-id">

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="take_profit_percent" class="form-label">Take Profit (%)</label>
                            <input type="number" class="form-control" name="take_profit_percent"
                                id="take_profit_percent" step="0.1" min="0" max="100" placeholder="e.g., 5.0">
                        </div>
                        <div class="col-md-6">
                            <label for="stop_loss_percent" class="form-label">Stop Loss (%)</label>
                            <input type="number" class="form-control" name="stop_loss_percent" id="stop_loss_percent"
                                step="0.1" min="0" max="100" placeholder="e.g., 2.0">
                        </div>
                    </div>

                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>Current P&L:</strong> <span id="edit-current-pnl">-</span>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="submit" form="editTradeForm" class="btn btn-primary">Save Changes</button>
            </div>
        </div>
    </div>
</div>

<!-- Close All Confirmation Modal -->
<div class="modal fade" id="closeAllModal" tabindex="-1" aria-labelledby="closeAllModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="closeAllModalLabel">
                    <i class="fas fa-exclamation-triangle me-2"></i>Close All Positions
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                    aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <strong>WARNING:</strong> You are about to close ALL {{ open_trades|length }} open position{{
                    open_trades|length|pluralize }}.
                </div>

                <div class="mb-4">
                    <h6 class="fw-bold">Positions to be closed:</h6>
                    <div class="row">
                        {% for trade in open_trades %}
                        <div class="col-md-6 mb-2">
                            <div class="border rounded p-2 bg-light">
                                <strong>{{ trade.symbol }}</strong> -
                                <span
                                    class="{% if trade.direction == 'buy' %}text-success{% else %}text-danger{% endif %}">
                                    {{ trade.direction|upper }}
                                </span>
                                {{ trade.quantity|floatformat:0 }}
                                {% if trade.alpaca_position %}
                                <small
                                    class="{% if trade.unrealized_pnl > 0 %}text-success{% elif trade.unrealized_pnl < 0 %}text-danger{% else %}text-muted{% endif %}">
                                    ({% if trade.unrealized_pnl > 0 %}+{% endif %}${{ trade.unrealized_pnl|floatformat:2
                                    }})
                                </small>
                                {% endif %}
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>

                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <strong>This action cannot be undone.</strong> All positions will be closed at current market
                    prices.
                </div>

                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="confirmCloseAll">
                    <label class="form-check-label fw-bold" for="confirmCloseAll">
                        I understand and want to close all positions
                    </label>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-1"></i>Cancel
                </button>
                <form method="post" style="display: inline;" id="closeAllForm">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="close_all">
                    <button type="submit" class="btn btn-danger" id="confirmCloseAllBtn" disabled>
                        <i class="fas fa-times-circle me-1"></i>Close All Positions
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
    // Close trade modal
    document.addEventListener('DOMContentLoaded', function () {
        const closeTradeModal = document.getElementById('closeTradeModal');
        closeTradeModal.addEventListener('show.bs.modal', function (event) {
            const button = event.relatedTarget;
            const tradeId = button.getAttribute('data-trade-id');
            const symbol = button.getAttribute('data-symbol');
            const quantity = button.getAttribute('data-quantity');
            const pnl = parseFloat(button.getAttribute('data-pnl')) || 0;

            document.getElementById('close-symbol').textContent = symbol;
            document.getElementById('close-quantity').textContent = quantity;
            document.getElementById('close-trade-id').value = tradeId;

            const pnlElement = document.getElementById('close-pnl');
            if (pnl > 0) {
                pnlElement.textContent = '+$' + pnl.toFixed(2);
                pnlElement.className = 'fw-bold text-success';
            } else if (pnl < 0) {
                pnlElement.textContent = '$' + pnl.toFixed(2);
                pnlElement.className = 'fw-bold text-danger';
            } else {
                pnlElement.textContent = '$0.00';
                pnlElement.className = 'fw-bold text-muted';
            }
        });

        // Edit trade modal
        const editTradeModal = document.getElementById('editTradeModal');
        editTradeModal.addEventListener('show.bs.modal', function (event) {
            const button = event.relatedTarget;
            const tradeId = button.getAttribute('data-trade-id');
            const pnl = parseFloat(button.getAttribute('data-current-pnl')) || 0;

            document.getElementById('edit-trade-id').value = tradeId;
            document.getElementById('edit-current-pnl').textContent = '$' + pnl.toFixed(2);
        });

        // Close All functionality
        const confirmCheckbox = document.getElementById('confirmCloseAll');
        const confirmButton = document.getElementById('confirmCloseAllBtn');

        if (confirmCheckbox && confirmButton) {
            confirmCheckbox.addEventListener('change', function () {
                confirmButton.disabled = !this.checked;
            });
        }
    });
</script>

<!-- Bootstrap 5 JavaScript Bundle -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
{% endblock %}